<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>しくみ</title>

    <!-- PCブラウザでタブに表示されるアイコン画像 -->
    <link rel="shortcut icon" href="img/favicon.png">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New&display=swap" rel="stylesheet">
    
    <!-- 共通 -->
    <script charset="utf-8" src="header.js"></script>
    <link href="style.css" rel="stylesheet">
    
</head>
<body>
    <header id="header-placeholder"></header>
    <main>
        <div class="article">
            <h1>しくみ</h1>
            <p>ここでは、「急がば漕げマップ」に表示されているデータがどのように処理・計算されているかを簡単にご紹介します。</p>

            <h2>概要</h2>
            <p>「急がば漕げマップ」では、東京の鉄道を点と線から表現される「グラフ」として表現することで、到達圏や最適経路、自転車ポテンシャルの分析を行っています。</p>
            <p>主に路線情報や時刻表の静的データを用いて、各駅を点（ノード）、それらをつなぐ鉄道や乗り換えなどのつながりを線（リンク）として整理することによって、それぞれのノード同士の間の最短経路を計算することができます。それぞれのリンクには平日日中の平均での所要時間が割り当てられており、東京および近郊での移動にかかる大まかな時間を考えています。</p>
            <p>これを用いて各駅から他のすべての駅までの所要時間を表示したものが到達圏マップで、ある駅から別の駅までのグラフ上での最短経路を検索することもできます。それぞれのリンクに着目したのがポテンシャルマップで、各リンクを利用する可能性のある人数を基に重要度を算出しています。</p>
            <p>より詳細にデータ処理などについて知りたい方は、引き続き読み進めてください。</p>
            
            <h2>グラフの構築</h2>
            <h3>使用データ</h3>
            <p>「急がば漕げマップ」では、公共交通オープンデータセンターにて提供されている鉄道・シェアサイクル関連データおよび国土数値情報の鉄道時系列データを主なソースとして利用しています。</p>
            <table>
                <caption>「急がば漕げマップ」に使用されているデータ一覧</caption>
                <tr>
                    <th>データ</th><th>使用目的</th><th>出典</th>
                </tr>
                <tr>
                    <td>鉄道運行関連データ</td><td>グラフの構築・計算</td><td><a href="https://ckan.odpt.org/dataset">公共交通オープンデータセンター</a></td>
                </tr>
                <tr>
                    <td>鉄道路線データ</td><td>地図上での表示・未提供データ補完</td><td><a href="https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N05-2023.html">国土数値情報 鉄道時系列データ</a></td>
                </tr>
                <tr>
                    <td>シェアサイクル関連GBFSデータ</td><td>施設整備・リアルタイム状況把握</td><td><a href="https://ckan.odpt.org/dataset">公共交通オープンデータセンター</a></td>
                </tr>
            </table>
            <p><a href="railway-data-process">後述</a>の通り、公共交通オープンデータセンターの配信データに含まれていないデータは、制作チームが他の情報源から補完してデータを作成しています。事業者ごとのデータの利用・補完状況は以下のとおりです。</p>
            <table class="explain-table" id="data-fill">
                <caption>事業者ごとのデータ利用・補完状況一覧</caption>
                <tr>
                    <th>事業者</th><th>補完状況</th>
                </tr>
                <tr>
                    <td>JR東日本・東京メトロ・東京都交通局・横浜市営地下鉄・東武鉄道・京王電鉄・相模鉄道・東京臨海高速鉄道・つくばエクスプレス</td>
                    <td>補完の必要なし</td>
                </tr>
                <tr>
                    <td>東急電鉄・京浜急行電鉄・小田急電鉄・西武鉄道・ゆりかもめ</td>
                    <td>列車時刻表未提供のため、各列車所要時間をウェブサイト等から補完</td>
                </tr>
                <tr>
                    <td>京成電鉄・新京成電鉄・北総鉄道・芝山鉄道・埼玉高速鉄道・東葉高速鉄道・横浜高速鉄道・東京モノレール・江ノ島電鉄・山万・千葉都市モノレール・関東鉄道・湘南モノレール・鹿島臨海鉄道・ひたちなか海浜鉄道・ニューシャトル・小湊鉄道・横浜シーサイドライン・流鉄・秩父鉄道・ディズニーリゾートライン・いすみ鉄道</td>
                    <td>データ未配信のため、全データを国土数値情報・ウェブサイト等から作成</td>
                </tr>
            </table>
            <h3>グラフの概要</h3>
            <p>今回構築したグラフの概要図は以下のとおりです。</p>
            <figure class="explanation_img">
                <img src="img/graph_main.png" alt="構築されたグラフの概要">
                <figcaption>構築したグラフの概要</figcaption>
            </figure>
            このように、駅の内部の構造および駅と駅の間の関係のそれぞれについて、それぞれの動きにかかる所要時間で重み付けしたグラフを構築します。
            それぞれのリンク・ノードの説明は以下のとおりです。なお、重みを0としているものは、最短経路探索における不具合を防ぐため、実際には0.01などの極めて小さい値を割り振っています。
            <table class="explain-table">
                <caption>構築したグラフのノード一覧</caption>
                <tr>
                    <th>種類</th><th>レイヤー</th><th>説明</th>
                </tr>
                <tr>
                    <td>自転車乗車ノード</td><td rowspan="2">自転車レイヤー</td><td rowspan="2">自転車に乗車・降車するためのノード。連続で自転車に乗ることを防ぐため、乗車・降車で別のノードを作成。</td>
                </tr>
                <tr>
                    <td>自転車降車ノード</td>
                </tr>
                <tr>
                    <td>駅入場ノード</td><td rowspan="2">地表レイヤー</td><td rowspan="2">鉄道に乗るための駅グループを表すノードで、徒歩・自転車・鉄道のすべての移動手段を繋ぐ役割を持つ。各駅間の到達時間は、出発駅・到着駅の入場・出場ノードの組み合わせの中で最短経路が最も短いものを採用。</td>
                </tr>
                <tr>
                    <td>駅出場ノード</td>
                </tr>
                <tr>
                    <td>路線・駅ノード</td><td>駅ナカレイヤー</td><td>各路線・駅を表すノードで、路線ごとにそれぞれ作成。乗り換え時にはこのレイヤーで路線間の行き来が行われ、地表レイヤーまでは行き着かない。例：「東京メトロ丸ノ内線 新宿駅」「JR山手線 新宿駅」</td>
                </tr>
                <tr>
                    <td>方面・種別ノード</td><td>列車レイヤー</td><td>各駅に停車する列車種別・方面を表すノード。通過する場合はこのノードは存在しない。上下線、各列車種別ごとに作成。列車はこのノード間を結ぶリンクとして存在する。例：「小田急小田原線 下北沢駅 快速急行 上り線」「小田急小田原線 下北沢駅 急行 上り線」</td>
                </tr>
            </table>
            <table class="explain-table explain-table-2">
                <caption>構築したグラフのリンク一覧</caption>
                <tr>
                    <th>種類</th><th>レイヤー</th><th>接続ノード</th><th>説明</th>
                </tr>
                <tr>
                    <td>自転車<wbr>リンク</td><td>自転車<wbr>レイヤー</td><td>自転車乗車ノード→<wbr>自転車降車ノード</td><td>駅間を自転車で移動する場合のリンク。駅間の道のりは直線距離の1.5倍、自転車の速さは分速300mと想定して所要時間を算出。</td>
                </tr>
                <tr>
                    <td>自転車<wbr>乗車<wbr>リンク</td><td>地表→<wbr>自転車<wbr>レイヤー</td><td>駅出場ノード→<wbr>自転車乗車ノード</td><td rowspan="2">シェアサイクルを乗り降りする場合に通るリンク。駅ーシェアサイクルポート間の移動・準備を想定し、所要時間は乗車・降車ともに一律5分としています。</td>
                </tr>
                <tr>
                    <td>自転車<wbr>降車<wbr>リンク</td><td>自転車→<wbr>地表<wbr>レイヤー</td><td>自転車降車ノード→<wbr>駅入場ノード</td>
                <tr>
                    <td>徒歩リンク</td><td>地表<wbr>レイヤー</td><td>駅出場ノード→<wbr>駅入場ノード</td><td>駅間を徒歩で移動する場合のリンク。駅間の道のりは直線距離の1.5倍、徒歩の速さは分速80mと想定して所要時間を算出。徒歩リンクを連続して通らないよう、出場ノードから入場ノードの一方通行としています。</td>
                </tr>
                <tr>
                    <td>入場<wbr>リンク</td><td>地表→<wbr>駅ナカ<wbr>レイヤー</td><td>駅入場ノード→<wbr>路線・駅ノード</td><td>鉄道に乗るために駅の中に入場するためのリンク。重みは0。</td>
                </tr>
                <tr>
                    <td>出場<wbr>リンク</td><td>駅ナカ→<wbr>地表<wbr>レイヤー</td><td>路線・駅ノード→<wbr>駅出場ノード</td><td>鉄道を下車し地表レイヤーに戻るためのリンク。重みは0。</td>
                </tr>
                <tr>
                    <td>乗り換え<wbr>リンク</td><td>駅ナカ<wbr>レイヤー</td><td>路線・駅<wbr>ノード<wbr>同士</td><td>鉄道路線間を乗り換えるためのリンク。所要時間の設定については<a href="#transfer-time">本ページ後半</a>にて解説しています。</td>
                </tr>
                <tr>
                    <td>乗車<wbr>リンク</td><td>駅ナカ→<wbr>列車<wbr>レイヤー</td><td>路線・駅ノード→<wbr>方面・種別ノード</td><td>列車に乗車する際に通るリンク。<a href="#waiting-time">平均待ち時間</a>で重み付けしています。
                    </td>
                </tr>
                <tr>
                    <td>降車<wbr>リンク</td><td>列車→<wbr>駅ナカ<wbr>レイヤー</td><td>方面・種別ノード→<wbr>路線・駅ノード</td><td>列車を降りる際に通るリンク。重みは0。</td>
                </tr>
                <tr>
                    <td>列車<wbr>リンク</td><td>列車<wbr>レイヤー</td><td>方面・種別<wbr>ノード<wbr>同士</td><td>各列車に乗って隣接駅に移動する際に通るリンク。<a href="#train-duration">列車の所要時間</a>で重み付け。</td>
                </tr>
                <tr>
                    <td>直通<wbr>リンク</td><td>列車<wbr>レイヤー</td><td>方面・種別<wbr>ノード<wbr>同士</td><td>異なる路線同士の直通運転の際に通るリンク。本線から支線への直通、地下鉄と郊外路線などの間の直通運転が存在する場合にリンクを付加しています。重み付けは一律で1分としています。
                    </td>
                </tr>
            </table>

            <h3 id="railway-data-process">鉄道データ処理</h3>
            <p>配信データをもとに、上記のネットワークのノードとリンクを作成していきます。今回は、平日日中（10-16時）を想定してデータを構築しています。
            データが配信されていない事業者や一部のみとなっている場合は、国土数値情報や各事業者ウェブサイト等の情報をもとに補完しています。</p>
            <p>国土数値情報を利用するにあたっては、<a href="https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N05-2023.html">鉄道時系列データ</a>から、現在運行されている路線を抽出して使用しています。</p>

            <h4>路線データ</h4>
            <p>公共交通オープンデータセンターの路線データが存在しない路線については、国土数値情報の鉄道時系列データをもとに、路線のデータおよび駅のデータをオープンデータチャレンジと同様の形式で生成しています。</p>

            <h4 id="train-duration">列車所要時間</h4>
            <p>列車リンクの重み付けは各駅間の所要時間としています。</p>
            <p>各種別の停車駅間の所要時間については、列車時刻表データを基に計算しています。それぞれの種別ごとに、平日日中に走るすべての列車の各停車駅間の所要時間の平均を求め、各リンクの所要時間として割り当てています。</p>
            <p>列車時刻表データ配信されていない路線については、鉄道会社ホームページや路線図などに記載されている各種別の駅間の所要時間をリンクの重みとして付与しています。</p>
            <p>平日日中に運行されていない種別は本プロジェクトの対象外としています。</p>

            <h4 id="waiting-time">平均待ち時間</h4>
            <p>乗車リンクの重みは平均待ち時間、すなわち平均運行間隔の半分の時間を割り当てています。</p>
            <p>駅時刻表データが配信されている路線については、駅時刻表の各種別の平日日中の運行本数を基に平均待ち時間を計算しています。データが配信されていない路線については、列車所要時間と同様にホームページなどを基に算出しています。</p>

            <h4 id="transfer-time">乗り換え時間</h4>
            <p>乗り換え時間については、それぞれの乗り換えの組み合わせに対し、以下の通り決めています。</p>
            <p>原則として、同一会社間の乗り換えの場合（東京メトロと都営地下鉄を除く）は一律3分、異なる会社間および東京の地下鉄路線同士の場合は一律5分に設定。</p>
            <p>ただし、同一ホーム乗り換えとなる場合（例：東京メトロ銀座線・丸ノ内線赤坂見附駅）や線路を共有している場合（例：北総鉄道・京成成田スカイアクセス線）は0.5分としています。</p>
            <p>これらに関わらず、大都市交通センサスにおける乗り換え時間調査が存在する乗り換えについては、その所要時間を使用しています。その他、極端に距離が長いなど個別に調整すべき箇所は適宜修正を加えています。</p>

            <h3>シェアサイクル情報</h3>
            <p>シェアサイクルに関する情報は、公共交通オープンデータセンターにて配信されているGBFSデータを使用しています。利用状況データは1分おきに更新します。各駅の集計データは、近接するサイクルポートの値を合計したものです。</p>
            <p>集計したデータを基に、サイクルポートが近接しているかどうかを判定し、必要に応じてグラフを編集します。</p>

            <h4>近接するシェアサイクルポートの考え方</h4>
            <p>近接するポートの検索においては、計算負荷軽減のためオープンソースの空間インデックスである<a href="https://h3geo.org/">H3</a>を活用しています。</p>
            <p>解像度10の六角形グリッド（1辺約28m）において、各駅および各サイクルポートが含まれるマスを計算した上でそのマス同士のグリッド上での距離を求めることで、簡便に2点間の距離の概算を求めることができます。</p>
            <p>マス目内の位置による誤差を考慮し、同一マス内であれば距離は50m以内、隣接マスであれば約100m、距離nの位置にあるマス同士の距離を50(n+1)mとしています。すなわち、下の図において、Aの位置にあるポートは駅からの距離50m以内、Bの位置であれば100m以内、Cであれば150m以内であると考えます。</p>
            <figure class="explanation_img" id="h3_img">
                <img src="img/h3_grid.png">
                <figcaption>六角形グリッドによる距離の概算の考え方</figcaption>
            </figure>
            <p>到達圏マップにおいてシェアサイクルポートが近接する駅のみを自転車ルートの対象とすることができますが、そこで設定される約300m以内、というのは隣接5マス以内を検索、という意味になります。このような距離計算を行っているため、実際の距離と計算された距離には多少の差があり、実際には設定距離以下のサイクルポートが含まれていなかったり、逆に設定距離をわずかに超えるサイクルポートが含まれたりする可能性があります。</p>
            <p>なお、自転車および徒歩移動における駅間の距離は、実際の直線距離を用いて算出されています。道のりは直線距離の1.5倍とし、自転車は分速300m、徒歩は分速80mと仮定して所要時間を求めています。</p>

            <h2>経路検索</h2>
            <p>本マップで表示される経路については、構築したネットワーク上における最速経路をダイクストラ法を用いて計算したものです。到達圏マップで表示している「自転車不使用」「自転車使用」「提案経路」は、以下の通りです。</p>

            <h3>自転車不使用</h3>
            <p>自転車を使用しない場合の最速経路です。構築したネットワークから自転車関連ノード・リンクを除いたものを用いて計算しています。徒歩のリンクは残っているため、駅間を徒歩で移動している場合があります。</p>

            <h3>自転車使用</h3>
            <p>自転車を1回以上必ず使用した場合の最速経路です。自転車リンクのうち、ユーザーが設定した自転車リンクの最短・最長距離から外れるリンクについては計算前に除外しています。また、シェアサイクルのある駅のみを使用する設定の場合は、近隣にシェアサイクルポートがある駅のみ自転車乗降可能としています。</p>
            <p>自転車の使用を必須にするため、ネットワーク全体を複製し自転車使用前・使用後レイヤーとした上で、自転車リンクのみによって両者を接続する構造を考えます。自転車使用前レイヤーにおける出発駅ノードから自転車使用後レイヤーにおける到着駅ノードまでの最速経路を計算することによって、自転車の使用を必須とした最速経路を算出しています。</p>

            <h3>提案経路</h3>
            <p>上記の2つの経路のうち、より適していると思われる方を提案経路として提示します。具体的には、双方の所要時間を比較し、自転車使用時の方が速い場合もしくは自転車使用によって増える所要時間がユーザーが設定した許容時間より短い場合は自転車使用経路、それ以上に時間を要してしまう場合には自転車不使用経路を提案経路として示します。</p>

            <h2>自転車ポテンシャルの計算</h2>
            <p>ポテンシャルマップにて表示されるサイクルポテンシャルについては、大都市交通センサスのODデータを基に、全員が提案経路を通ると仮定したときの1日あたりの自転車利用客数として算出しています。具体的な計算方法は以下の通りです。</p>
            <p>駅間の移動人数として、大都市交通センサスの2次ODデータを使用しています。発着駅の組み合わせごとに1日あたりの利用人数xを集計し、自転車利用も含めた提案経路を計算します。提案経路上に自転車の利用がある場合、その自転車リンクおよび両端の駅の自転車ポテンシャルにxを加算します。これをすべてのODペアに対して繰り返すことで、その駅および自転車リンクの利用されうる人数を求めています。各駅の規模の指標としてよく用いられる1日あたり乗降客数と単位を揃えているので、自転車ポテンシャルの規模を体感として分かりやすく提示しています。</p>
            <p>この計算方法は、グラフ理論におけるノードおよびリンクの重要性を示す指標のひとつである媒介中心性 (Betweenness Centrality) の考え方を援用しています。ODデータが存在する駅同士のみを発着駅とし、その重要度をOD間のフローで重み付けして計算しています。</p>

            <h2>今回の手法の限界</h2>
            <p>今回使用した手法には以下の制約・限界があります。以下の点をご確認いただき、本マップでは平均的な情報を示しているものであることに留意したうえで、具体的な旅行の計画においては、乗換検索サービス等による確認をお願いいたします。</p>

            <h3>平均待ち時間の使用による制約</h3>
            <p>列車乗車時の待ち時間を、種別ごとの各駅での平均待ち時間として計算しているため、実際の待ち時間とは異なる場合があります。また、上下線で所要時間が異なる場合もあります。例えば、以下のような場合が想定されます。</p>

            <ul>
                <li>複数の種別が利用可能な場合でも平均待ち時間が個別に計算されるため、実態よりも待ち時間が長くなります。</li>
                <li>一部列車が途中駅止まり、他の支線に直通する場合でも、出発駅における当該種別の運行本数に基づき平均待ち時間が計算されるため、実際に利用できる列車の待ち時間より短くなります。</li>
                <li>上記に関連し、運行頻度の高い駅から運行頻度の低い駅までの経路の方が出発駅における待ち時間が短いため、逆の経路と比べて所要時間が短くなります。</li>
                <li>異なる種別同士の連絡や支線区との乗換など、接続が考慮されたダイヤが組まれている場合でも、乗り換え時間は平均待ち時間となるため実態よりも長くなります。</li>
                <li>極端に運行間隔が広い場合、鉄道利用が表示されずに徒歩や自転車による移動のみ表示される場合があります。</li>
            </ul>

            <h3>徒歩・自転車の移動時間に関する制約</h3>
            <p>駅間の徒歩・自転車移動については、道のりを駅間の直線距離の1.5倍と仮定して所要時間を計算しているため、実際の移動距離とは異なる可能性があります。</p>
            <p>特に、河川や大通りをわたる場合など大きく迂回する必要がある場合などにおいては、実際の所要時間が地図上の表示を大幅に上回ってしまうことがあります。</p>

            <h3>自転車の連続使用に関する限界</h3>
            <p>自転車の連続使用は発生しづらいようネットワークの構造は工夫してありますが、鉄道利用が極端に不便な場合においては、自転車を連続で使用する経路が表示される場合があります。この場合、合計の自転車移動距離がユーザーが設定した範囲を上回ります。</p>
            <p>経路においては途中の駅でサイクルポートと駅の徒歩での往復（合計10分）が表示されますので、休憩時間と捉え引き続き自転車に乗りましょう！</p>

            <h3>自転車の強制使用に関する限界</h3>
            <p>自転車を必ず使用する場合の経路選択において、（本来は直接乗り換えられるはずの）乗換駅前後で短区間のアリバイ的な自転車利用が行われる場合があります。この場合、自転車の最短利用距離を長く設定することで、より有効な自転車利用経路が表示される可能性を上げることができます。</p>
            <p>ポテンシャルマップにおいても、このような利用によるターミナル駅付近の利用が増大しており、過大評価されている可能性があります。</p>

            <h3>大都市交通センサスのデータ提供範囲とネットワーク構築範囲の違いによる限界</h3>
            <p>ポテンシャルマップにおいて表示されるポテンシャルは、大都市交通センサスのデータを用いて計算されていますが、センサスの集計範囲と今回のネットワーク構築範囲が異なるため、一部区間においてポテンシャルが表示されなかったり、ポテンシャルの値が実態と異なる場合があります。具体的な違いは以下の通りです。</p>

            <h4>大都市交通センサスのデータが提供されているがネットワークを構築していない路線</h4>
            <p>JR水戸線、JR両毛線、JR中央本線（高尾以西）、JR御殿場線、箱根登山鉄道線、伊豆箱根鉄道大雄山線</p>
            <h4>ネットワークが構築されているが大都市交通センサスのデータが無い路線</h4>
            <p>JR東海道本線（湯河原以西）・JR伊東線、JR東北本線（小山以北）、JR総武本線（横芝以東）、JR成田線（小見川以東）、JR高崎線（神保原以北）、JR八高線（児玉以北）、JR常磐線（石岡以北）、東急新横浜線（調査時未開通）、相鉄新横浜線（新横浜～羽沢横浜国大：調査時未開通）、東武伊勢崎線（多々良以北）、東武宇都宮線（野州大塚以北）、東武日光線（家中以北）、東武桐生線、東武小泉線、東武鬼怒川線、都電荒川線、秩父鉄道（波久礼以西）、いすみ鉄道（城見ヶ丘以東）、銚子電鉄、鹿島臨海鉄道、ひたちなか海浜鉄道、ディズニーリゾートライン
            </p>



            <h2>使用言語・パッケージ等</h2>
            <p>データの取得・処理にはPython、オンラインマップはJavaScriptを使用しています。</p>
            <ul>
                <li>Python：データの取得・処理
                    <ul>
                        <li><a href="https://pandas.pydata.org/">Pandas</a>：テーブルデータの処理</li>
                        <li><a href="https://geopandas.org/en/stable/">GeoPandas</a>：地理空間情報の処理</li>
                        <li><a href="https://networkx.org/">NetworkX</a>：グラフの作成・保存</li>
                        <li><a href="https://h3geo.org/">H3</a>：空間インデックス（距離探索などの軽量化のために活用）</li>
                    </ul>
                </li>
                <li>JavaScript：地図のオンラインでの表示
                    <ul>
                        <li><a href="https://maplibre.org/maplibre-gl-js/docs/">MapLibre GL JS</a>：オープンソースのウェブGIS</li>
                        <li><a href="https://h3geo.org/">H3</a>：空間インデックス（上記同様）</li>
                        <li><a href="https://d3js.org/">D3.js</a>：グラフ等の表示</li>
                    </ul>
                </li>
            </ul>
        </div>
    </main>
</body>
</html>